---
# Elasticsearch Stateful Deployment
apiVersion: elasticsearch.k8s.elastic.co/v1
kind: Elasticsearch
metadata:
  name: elastic-cluster
  namespace: elastic
spec:
  version: 8.16.1
  nodeSets:
    # Master Nodes (3 for HA)
    - name: master-nodes
      count: 3
      config:
        node.roles: ["master"]
        cluster.name: "elastic-cluster"
        cluster.routing.allocation.awareness.attributes: "zone"  # Zone awareness
      podTemplate:
        spec:
          nodeSelector:
            role: master
          initContainers:
            - name: sysctl
              securityContext:
                privileged: true
                runAsUser: 0
              command: ['sh', '-c', 'sysctl -w vm.max_map_count=262144']
          containers:
            - name: elasticsearch
              resources:
                requests:
                  memory: "4Gi"
                  cpu: "2"
                limits:
                  memory: "4Gi"
                  cpu: "2"
      volumeClaimTemplates:
        - metadata:
            name: elasticsearch-data
          spec:
            accessModes: ["ReadWriteOnce"]
            storageClassName: premium-rwo
            resources:
              requests:
                storage: 50Gi

    # Data Nodes (StatefulSet for persistence)
    - name: data-nodes
      count: 2
      config:
        node.roles: ["data"]
        cluster.routing.allocation.awareness.attributes: "zone"  # Zone awareness for data nodes
      podTemplate:
        spec:
          nodeSelector:
            role: data
          initContainers:
            - name: sysctl
              securityContext:
                privileged: true
                runAsUser: 0
              command: ['sh', '-c', 'sysctl -w vm.max_map_count=262144']
          containers:
            - name: elasticsearch
              resources:
                requests:
                  memory: "32Gi"
                  cpu: "8"
                limits:
                  memory: "32Gi"
                  cpu: "8"
      volumeClaimTemplates:
        - metadata:
            name: elasticsearch-data
          spec:
            accessModes: ["ReadWriteOnce"]
            storageClassName: premium-rwo
            resources:
              requests:
                storage: 24Ti  # Each data node gets 24Ti storage

    # Ingest Nodes (2 for HA)
    - name: ingest-nodes
      count: 2
      config:
        node.roles: ["ingest"]
        cluster.routing.allocation.awareness.attributes: "zone"
      podTemplate:
        spec:
          nodeSelector:
            role: shared
          initContainers:
            - name: sysctl
              securityContext:
                privileged: true
                runAsUser: 0
              command: ['sh', '-c', 'sysctl -w vm.max_map_count=262144']
          containers:
            - name: elasticsearch
              resources:
                requests:
                  memory: "4Gi"
                  cpu: "2"
                limits:
                  memory: "4Gi"
                  cpu: "2"
      volumeClaimTemplates:
        - metadata:
            name: elasticsearch-data
          spec:
            accessModes: ["ReadWriteOnce"]
            storageClassName: premium-rwo
            resources:
              requests:
                storage: 50Gi

    # Coordinator Nodes (2 for HA)
    - name: coordinator-nodes
      count: 2
      config:
        node.roles: []
        cluster.routing.allocation.awareness.attributes: "zone"
      podTemplate:
        spec:
          nodeSelector:
            role: shared
          initContainers:
            - name: sysctl
              securityContext:
                privileged: true
                runAsUser: 0
              command: ['sh', '-c', 'sysctl -w vm.max_map_count=262144']
          containers:
            - name: elasticsearch
              resources:
                requests:
                  memory: "4Gi"
                  cpu: "2"
                limits:
                  memory: "4Gi"
                  cpu: "2"
      volumeClaimTemplates:
        - metadata:
            name: elasticsearch-data
          spec:
            accessModes: ["ReadWriteOnce"]
            storageClassName: premium-rwo
            resources:
              requests:
                storage: 50Gi

    # Transform Nodes (2 for HA)
    - name: transform-nodes
      count: 2
      config:
        node.roles: ["transform"]
        cluster.routing.allocation.awareness.attributes: "zone"
      podTemplate:
        spec:
          nodeSelector:
            role: shared
          initContainers:
            - name: sysctl
              securityContext:
                privileged: true
                runAsUser: 0
              command: ['sh', '-c', 'sysctl -w vm.max_map_count=262144']
          containers:
            - name: elasticsearch
              resources:
                requests:
                  memory: "4Gi"
                  cpu: "2"
                limits:
                  memory: "4Gi"
                  cpu: "2"
      volumeClaimTemplates:
        - 
